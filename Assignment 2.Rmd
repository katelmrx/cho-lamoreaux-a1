---
title: "Assignment 2"
author: "Sungjoo Cho, Catherine (Kate) Lamoreaux"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gtrendsR)
library(censusapi)
library(gtrendsR)
library(magrittr)

if (!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
library(magrittr)

library(censusapi)
```

## Pulling from APIs

```{r}
# pulling from APIs
res <- gtrends(c("crime", "loans"),
               geo = "US-IL",
               time = "2020-01-01 2020-12-31",
               low_search_volume = TRUE)
head(res)
plot(res)

# transforming the `data.frame` into a `tibble`
str(res)
res_time <- as_tibble(res$interest_over_time)

glimpse(res_time)
head(table(res_time$date))
table(res_time$keyword)
table(res_time$geo)
```

### Answer the following questions for the keywords "crime" and "loans".

-   Find the mean, median and variance of the search hits for the keywords.

```{r}
# mean, median and variance of the search hits for the keywords
stat_keywords <- res_time %>%
  group_by(keyword) %>%
  summarize(mean = mean(hits),
            median = median(hits),
            variance = var(hits))

stat_keywords
knitr::kable(stat_keywords, caption = "Statistics of the search hits for the keywords")
```

-   Which cities (locations) have the highest search frequency for loans? Note that there might be multiple rows for each city if there were hits for both "crime" and "loans" in that city. It might be easier to answer this question if we had the search hits info for both search terms in two separate variables. That is, each row would represent a unique city.

Justice has the highest search frequency for loans.

```{r}
# using pivot_wider
res_city <- res$interest_by_city %>%
  pivot_wider(names_from = keyword,
              values_from = hits)

# changing NA values to 0 for loans
res_city['loans'][is.na(res_city['loans'])] <- 0

# sorting
res_city <- res_city[order(-res_city$loans), ]
head(res_city)
```

-   Is there a relationship between the search intensities between the two keywords we used?

The correlation between the search intensities of the two keywords is -0.1433. From the plot below shows the number of search hits (crime and loans) changes over time.

```{r}
# changing NA values to 0 for loans
res_city['crime'][is.na(res_city['crime'])] <- 0

# correlation
cor(res_city$crime, res_city$loans)

# plot of the number of search hits changes over time
plot(res)
```

### Repeat the above for keywords related to covid. Make sure you use multiple keywords like we did above. Try several different combinations and think carefully about words that might make sense within this context.

-   Potential keywords to test: fauci, trump, bleach, ivermectin, lockdown, lockdowns, pandemic, china, deaths, death, new york city, nyc, doctor, doctors, nurse, nurses, hospitals, hospitals full, virus, coronavirus, mask, vaccine, mask, travel

-   Current graph: covid, trump, death, mask, virus

```{r}
# pulling from APIs with keywords (covid, trump, death, mask, virus)
res_covid <- gtrends(c("covid", "trump", "death", "mask", "virus"),
               geo = "US-IL", 
               time = "2020-02-01 2021-03-01", 
               low_search_volume = TRUE)
head(res_covid)
plot(res_covid)
str(res_covid)

# transforming the `data.frame` into a `tibble`
res_covid_time <- as_tibble(res_covid$interest_over_time)
head(res_covid_time)

# changing '<1' values to 0 for hits values
res_covid_time$hits <- ifelse(res_covid_time$hits == '<1', 0, res_covid_time$hits)    
res_covid_time$hits <- as.integer(res_covid_time$hits)
str(res_covid_time)

glimpse(res_covid_time)
head(table(res_covid_time$date))
table(res_covid_time$keyword)
table(res_covid_time$geo)
```

Answer the following questions for the keywords "covid" and "[ENTER CHOSEN KEYWORD HERE".

-   Find the mean, median and variance of the search hits for the keywords.

```{r}
# mean, median and variance of the search hits for the keywords
stat_covid_keywords <- res_covid_time %>%
  group_by(keyword) %>%
  summarize(mean = mean(hits),
            median = median(hits),
            variance = var(hits))

knitr::kable(stat_covid_keywords, caption = "Statistics of the search hits for the keywords")
```

-   Which cities (locations) have the highest search frequency for `covid`? (Note that there might be multiple rows for each city if there were hits for keywords in that city. It might be easier to answer this question if we had the search hits info for both search terms in two separate variables. That is, each row would represent a unique city. \*From Kate: we may not need this text? Adapted it from above.)

* From Sungjoo: Getting errors/warning for some reasons,,?

```{r}
# using pivot_wider
res_covid_city <- res_covid$interest_by_city %>%
  pivot_wider(names_from = keyword,
              values_from = hits)

# changing NA values to 0 for loans
res_covid_city['covid'][is.na(res_covid_city['covid'])] <- 0

# sorting
res_city <- res_city[order(-res_city$loans), ]
head(res_city)
```

-   Is there a relationship between the search intensities between the two keywords we used?

    ```{r}

    ```

## Google Trends + ACS

Now lets add another data set. The `censusapi` package provides a nice R interface for communicating with this API. However, before running queries we need an access key. This (easy) process can be completed here:

<https://api.census.gov/data/key_signup.html>

Once you have an access key, store this key in the `cs_key` object. We will use this object in all following API queries.

```{r}
#| eval: false
cs_key <- "your key here" #From Kate: save your key as a separate text file that you don't upload to git. You should use your individual keys, privately.
```

In the following, we request basic socio-demographic information (population, median age, median household income, income per capita) for cities and villages in the state of Illinois.

```{r}
#| eval: false

acs_il <- getCensus(name = "acs/acs5",
                    vintage = 2020, 
                    vars = c("NAME", 
                             "B01001_001E", 
                             "B06002_001E", 
                             "B19013_001E", 
                             "B19301_001E"), 
                    region = "place:*", 
                    regionin = "state:17",
                    key = cs_key)
head(acs_il)
```

Convert values that represent missings to NAs.

```{r}
#| eval: false

acs_il[acs_il == -666666666] <- NA
```

Now, it might be useful to rename the socio-demographic variables (`B01001_001E` etc.) in our data set and assign more meaningful names.

```{r}
#| eval: false
acs_il <-
  acs_il %>%
  rename(pop = 'B01001_001E', 
         age = 'B06002_001E', 
         hh_income = 'B19013_001E', 
         income = 'B19301_001E')
```

It seems like we could try to use this location information listed above to merge this data set with the Google Trends data. However, we first have to clean `NAME` so that it has the same structure as `location` in the search interest by city data. Add a new variable `location` to the ACS data that only includes city names.

Answer the following questions with the "crime" and "loans" Google trends data and the ACS data.

-   First, check how many cities don't appear in both data sets, i.e. cannot be matched. Then, create a new data set by joining the Google Trends and the ACS data. Keep only cities that appear in both data sets.

```{r}
# creating a new variable 'location' that only includes city names
no_illinois <- gsub(", Illinois", '', acs_il$NAME)
no_village <- gsub(" village", '', no_illinois)
no_city <- gsub(" city", '', no_village)
no_cdp <- gsub(" CDP", '', no_city)
acs_with_location <- acs_il %>%
  mutate(location = no_cdp)
head(acs_with_location)

# the number of observations
nrow(acs_with_location)
nrow(res_city)
```

-   Compute the mean of the search popularity for both keywords for cities that have an above average median household income and for those that have an below average median household income. When building your pipe, start with creating the grouping variable and then proceed with the remaining tasks. What conclusions might you draw from this?

```{r}
# finding out missing values in the household income variable
merge_acs_gtrend$hh_income

# removing NA values
merge_acs_gtrend <- merge_acs_gtrend %>%
  drop_na(hh_income)

# creating the grouping variable
merge_acs_gtrend <- merge_acs_gtrend %>%
  mutate(income_group = ifelse(hh_income>median(hh_income), 'Above', 'Below'))
head(merge_acs_gtrend)

# compute the mean of the search popularity for both keywords by income group
mean_income_keywords <- merge_acs_gtrend %>%
  group_by(income_group) %>%
  summarise(mean_crime = mean(crime),
            mean_loans = mean(loans))

kable(mean_income_keywords, caption = "The Mean of the Search Popularity for Both Keywords by Income Groups")
```

-   Is there a relationship between the median household income and the search popularity of the Google trends terms? Describe the relationship and use a scatterplot with `qplot()`.

    ```{r}

    ```

Repeat the above steps using the covid data and the ACS data.

-   First, check how many cities don't appear in both data sets, i.e. cannot be matched. Then, create a new data set by joining the Google Trends and the ACS data. Keep only cities that appear in both data sets.

    ```{r}

    ```

-   Compute the mean of the search popularity for both keywords for cities that have an above average median household income and for those that have an below average median household income. When building your pipe, start with creating the grouping variable and then proceed with the remaining tasks. What conclusions might you draw from this?

    ```{r}

    ```

-   Is there a relationship between the median household income and the search popularity of the Google trends terms? Describe the relationship and use a scatterplot with `qplot()`.

    ```{r}

    ```

    > > > > > > > b192c6cd3d9542ee1a18b0e7d4f8984f8769b518
